<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>research-hub-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">research-hub-web documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search">
</div>
            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>Person</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/components/request-storage/request-storage.component.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#access">access</a>
                                </li>
                                <li>
                                        <a href="#email">email</a>
                                </li>
                                <li>
                                        <a href="#firstName">firstName</a>
                                </li>
                                <li>
                                        <a href="#lastName">lastName</a>
                                </li>
                                <li>
                                        <a href="#roles">roles</a>
                                </li>
                                <li>
                                        <a href="#username">username</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="access"></a>
                                        <span class="name"><b>access</b><a href="#access"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>access:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="email"></a>
                                        <span class="name"><b>email</b><a href="#email"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>email:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="firstName"></a>
                                        <span class="name"><b>firstName</b><a href="#firstName"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>firstName:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="lastName"></a>
                                        <span class="name"><b>lastName</b><a href="#lastName"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>lastName:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="roles"></a>
                                        <span class="name"><b>roles</b><a href="#roles"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>roles:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="username"></a>
                                        <span class="name"><b>username</b><a href="#username"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>username:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {Component, ElementRef, OnDestroy, OnInit, ViewChild} from &#x27;@angular/core&#x27;;
import {FormArray, FormBuilder, FormControl, FormGroup, Validators} from &#x27;@angular/forms&#x27;;
import {DateAdapter, NativeDateAdapter} from &#x27;@angular/material/core&#x27;;
import {CerApiService} from &#x27;app/services/cer-api.service&#x27;;
import {AuthService} from &#x27;../../services/auth.service&#x27;;
import {MatHorizontalStepper} from &#x27;@angular/material/stepper&#x27;;
import {AppComponentService} from &#x27;../../app.component.service&#x27;;
import {HttpErrorResponse} from &#x27;@angular/common/http&#x27;;
import {Location} from &#x27;@angular/common&#x27;;
import {MatDialog} from &#x27;@angular/material/dialog&#x27;;
import {ErrorDialogComponent} from &#x27;../shared/error-dialog/error-dialog.component&#x27;;
import {ActivatedRoute} from &#x27;@angular/router&#x27;;
import {Subscription} from &#x27;rxjs/Subscription&#x27;;
import {AnalyticsService} from &#x27;../../services/analytics.service&#x27;;
import * as format from &#x27;date-fns/format&#x27;;
import * as subYears from &#x27;date-fns/sub_years&#x27;;
import {ConfirmDialogComponent} from &#x27;../shared/confirm-dialog/confirm-dialog.component&#x27;;
import {CanComponentDeactivate} from &#x27;../../routing/routing.confirm-deactivate&#x27;;
import {ResearchHubApiService} from &#x27;../../services/research-hub-api.service&#x27;;


interface Person {
  firstName: string;
  lastName: string;
  email: string;
  username: string;
  access: string;
  roles: string[];
}


@Component({
  selector: &#x27;app-request-data&#x27;,
  templateUrl: &#x27;./request-storage.component.html&#x27;,
  styleUrls: [&#x27;./request-storage.component.scss&#x27;]
})
export class RequestStorageComponent implements OnInit, OnDestroy, CanComponentDeactivate {
  private requestFormKey &#x3D; &#x27;requestStorageForm&#x27;;

  @ViewChild(&#x27;resultsDummyHeader&#x27;) private resultsDummyHeader: ElementRef;
  @ViewChild(&#x27;stepper&#x27;) stepper: MatHorizontalStepper;
  public dateToday &#x3D; new Date();
  public submitting &#x3D; false;
  private routeParamsSub: Subscription;
  private stepperSub: Subscription;
  private dataRequirementsSub: Subscription;
  private endDateSub: Subscription;
  public title &#x3D; &#x27;Request Research Storage&#x27;;
  public image &#x3D; &#x27;content/vault.jpg&#x27;;
  public response: any;
  public storageTypeForm: FormGroup;
  public projectForm: FormGroup;
  public dataInfoForm: FormGroup;
  public dataSizeForm: FormGroup;
  private lastStepIndex &#x3D; 4;
  public isEditable &#x3D; true;
  public showOtherField &#x3D; false;
  public projectMembers: FormArray;
  public storageTypeClicked &#x3D; false;
  public showSizeNextYear &#x3D; true;

  public storageOptionsList &#x3D; [
    &#x27;Dropbox&#x27;,
    &#x27;Network Research Storage&#x27;,
    &#x27;Archive&#x27;,
    &#x27;I don\&#x27;t know&#x27;
  ]

  public fieldOfResearchCodes &#x3D; [
    &#x27;01 Mathematical Sciences&#x27;,
    &#x27;02 Physical Sciences&#x27;,
    &#x27;03 Chemical Sciences&#x27;,
    &#x27;04 Earth Sciences&#x27;,
    &#x27;05 Environmental Sciences&#x27;,
    &#x27;06 Biological Sciences&#x27;,
    &#x27;07 Agricultural and Veterinary Sciences&#x27;,
    &#x27;08 Information and Computing Sciences&#x27;,
    &#x27;09 Engineering&#x27;,
    &#x27;10 Technology&#x27;,
    &#x27;11 Medical and Health Sciences&#x27;,
    &#x27;12 Built Environment and Design&#x27;,
    &#x27;13 Education&#x27;,
    &#x27;14 Economics&#x27;,
    &#x27;15 Commerce, Management, Tourism and Services&#x27;,
    &#x27;16 Studies in Human Society&#x27;,
    &#x27;17 Psychology and Cognitive Sciences&#x27;,
    &#x27;18 Law and Legal Studies&#x27;,
    &#x27;19 Studies in Creative Arts and Writing&#x27;,
    &#x27;20 Language, Communication and Culture&#x27;,
    &#x27;21 History and Archaeology&#x27;,
    &#x27;22 Philosophy and Religious Studies&#x27;,
    &#x27;Other&#x27;
  ];

  public dataRequirements &#x3D; [
    &#x27;Part of a funded project research&#x27;,
    &#x27;Requires human ethics research&#x27;,
    &#x27;Requires animal ethics&#x27;,
    &#x27;Part of clinical research&#x27;,
    &#x27;Research involving children&#x27;,
    &#x27;Commercially sensitive&#x27;,
    &#x27;Research involves patent application&#x27;,
    &#x27;Requires encryption on disk&#x27;,
    &#x27;Need for external collaborator access&#x27;,
    &#x27;Requirement to delete data at end of project&#x27;,
    &#x27;Other&#x27;
  ];

  public units &#x3D; [
    &#x27;Gigabytes&#x27;,
    &#x27;Terabytes&#x27;
  ];

  public access &#x3D; [
    &#x27;Full Access&#x27;,
    &#x27;Read Only&#x27;
  ];

  public roleTypes &#x3D; [
    &#x27;Data Owner&#x27;,
    &#x27;Data Contact&#x27;,
    &#x27;Project Member&#x27;
  ];

  constructor(private formBuilder: FormBuilder, dateAdapter: DateAdapter&lt;NativeDateAdapter&gt;,
              private cerApiService: CerApiService, public apiService: ResearchHubApiService,
              public authService: AuthService, private appComponentService: AppComponentService,
              public dialog: MatDialog, private location: Location, private route: ActivatedRoute,
              private analyticsService: AnalyticsService, private el: ElementRef) {
    dateAdapter.setLocale(&#x27;en-GB&#x27;);
  }

  ngOnInit() {
    this.analyticsService.trackIntegratedService(this.title, this.location.path());

    this.storageTypeForm &#x3D; this.formBuilder.group({
      storageType: new FormControl(undefined, Validators.required),
      storageOptions: new FormControl(undefined, Validators.required)
    });

    this.projectForm &#x3D; this.formBuilder.group({
      title: new FormControl(undefined, Validators.required),
      abstract: new FormControl(undefined, [Validators.required, Validators.minLength(50)]),
      endDate: new FormControl(undefined, [Validators.required]),
      fieldOfResearch: new FormControl(undefined, Validators.required),
    });

    this.projectMembers &#x3D; this.formBuilder.array([], Validators.compose([Validators.required]));

    this.dataInfoForm &#x3D; this.formBuilder.group({
      dataRequirements: new FormControl(undefined),
      dataRequirementsOther: new FormControl(undefined),
      shortName: new FormControl(undefined),
      projectMembers: this.projectMembers
    });

    this.dataRequirementsSub &#x3D; this.dataInfoForm.get(&#x27;dataRequirements&#x27;).valueChanges.subscribe(
      (items: string[]) &#x3D;&gt; {
        const dataRequirementsOther &#x3D; this.dataInfoForm.get(&#x27;dataRequirementsOther&#x27;);
        this.showOtherField &#x3D; items &amp;&amp; items.find((item) &#x3D;&gt; item &#x3D;&#x3D;&#x3D; &#x27;Other&#x27;) !&#x3D;&#x3D; undefined;

        if (this.showOtherField) {
          dataRequirementsOther.setValidators([Validators.required]);
        } else {
          dataRequirementsOther.setValidators([]);
          dataRequirementsOther.setValue(undefined);
        }
      }
    );

    this.dataSizeForm &#x3D; this.formBuilder.group({
      sizeThisYear: new FormControl(undefined, [Validators.required, Validators.min(1)]),
      unitThisYear: new FormControl(this.units[0], Validators.required),
      sizeNextYear: new FormControl(undefined, [Validators.required, Validators.min(1)]),
      unitNextYear: new FormControl(this.units[0], Validators.required),
      comments: new FormControl(undefined)
    });

    this.endDateSub &#x3D; this.projectForm.get(&#x27;endDate&#x27;).valueChanges.subscribe(
      (date: Date) &#x3D;&gt; {
        this.showSizeNextYear &#x3D; new Date() &lt;&#x3D; subYears(date, 1);

        const sizeNextYear &#x3D; this.dataSizeForm.get(&#x27;sizeNextYear&#x27;);
        const unitNextYear &#x3D; this.dataSizeForm.get(&#x27;unitNextYear&#x27;);

        if (this.showSizeNextYear) {
          sizeNextYear.setValidators([Validators.required, Validators.min(1)]);
          unitNextYear.setValidators([Validators.required]);
        } else {
          sizeNextYear.setValidators(null);
          unitNextYear.setValidators(null);

          sizeNextYear.setValue(undefined);
          unitNextYear.setValue(undefined);
        }
      }
    );

    // Pre-populate first person in list with logged in user
    const user &#x3D; this.authService.user;
    this.addPerson({
      firstName: user.firstName,
      lastName: user.lastName,
      email: user.mail,
      username: user.uid,
      access: &#x27;Full Access&#x27;,
      roles: []
    });

    this.routeParamsSub &#x3D;
      this.route.queryParams
        .subscribe(params &#x3D;&gt; {
          const retry &#x3D; params[&#x27;retry&#x27;];

          if (retry) {
            this.loadRequest();
          } else {
            this.clearRequest();
          }
        });

    this.stepperSub &#x3D; this.stepper.selectionChange.subscribe(selection &#x3D;&gt; {
      this.isEditable &#x3D; selection.selectedIndex !&#x3D;&#x3D; this.lastStepIndex;
      this.resultsDummyHeader.nativeElement.scrollIntoView();
    });
  }

  canDeactivate() {
    if ((!this.storageTypeForm.dirty &amp;&amp; !this.projectForm.dirty &amp;&amp; !this.dataInfoForm.dirty &amp;&amp; !this.dataSizeForm.dirty) || this.response !&#x3D;&#x3D; undefined) {
      return true;
    }

    const dialogRef &#x3D; this.dialog.open(ConfirmDialogComponent, {
      data: {
        title: &#x27;Leave form?&#x27;,
        message: &#x27;Leaving this form will delete all of the information you have filled in.&#x27;
      }
    });
    const afterClosedObs &#x3D; dialogRef.afterClosed();
    const afterClosedSub &#x3D; afterClosedObs.subscribe();

    return afterClosedObs.map(result &#x3D;&gt; {
      afterClosedSub.unsubscribe();
      return result;
    }).first();
  }

  saveRequest() {
    const form &#x3D; {
      storageTypeForm: this.storageTypeForm.getRawValue(),
      projectForm: this.projectForm.getRawValue(),
      dataInfoForm: this.dataInfoForm.getRawValue(),
      dataSizeForm: this.dataSizeForm.getRawValue()
    };

    localStorage.setItem(this.requestFormKey, JSON.stringify(form));
  }

  loadRequest() {
    let form &#x3D; localStorage.getItem(this.requestFormKey);

    if (form !&#x3D;&#x3D; null) {
      form &#x3D; JSON.parse(form);

      this.storageTypeForm.setValue(form[&#x27;storageTypeForm&#x27;]);
      this.projectForm.setValue(form[&#x27;projectForm&#x27;]);
      this.dataInfoForm.setValue(form[&#x27;dataInfoForm&#x27;]);
      this.dataSizeForm.setValue(form[&#x27;dataSizeForm&#x27;]);

      this.stepper.selectedIndex &#x3D; this.lastStepIndex - 1; // Navigate to last step
    }
  }

  clearRequest() {
    localStorage.removeItem(this.requestFormKey)
  }

  addNewPerson() {
    this.addPerson({
      firstName: undefined,
      lastName: undefined,
      email: undefined,
      username: undefined,
      access: undefined,
      roles: []
    });
  }

  addPerson(person: Person) {
    const control &#x3D; &lt;FormArray&gt;this.dataInfoForm.get(&#x27;projectMembers&#x27;);
    control.push(
      this.formBuilder.group({
        firstName: new FormControl(person.firstName, Validators.required),
        lastName: new FormControl(person.lastName, Validators.required),
        email: new FormControl(person.email, Validators.required),
        username: new FormControl(person.username),
        access: new FormControl(person.access, Validators.required),
        roles: new FormControl(person.roles, Validators.required)
      })
    );
  }

  deletePerson(index: number) {
    const control &#x3D; &lt;FormArray&gt;this.dataInfoForm.get(&#x27;projectMembers&#x27;);
    control.removeAt(index);
  }

  ngOnDestroy() {
    this.routeParamsSub.unsubscribe();
    this.stepperSub.unsubscribe();
    this.dataRequirementsSub.unsubscribe();
    this.endDateSub.unsubscribe();
  }

  showErrorDialog(title: string, message: string, closeButtonName: string, timeout: number) {
    return this.dialog.open(ErrorDialogComponent, {
      data: {
        title: title,
        message: message,
        closeButtonName: closeButtonName,
        timeout: timeout
      }
    });
  }

  submit() {
    const isValid &#x3D; this.dataSizeForm.valid;
    this.dataSizeForm.markAsTouched();
    this.dataSizeForm.markAsDirty();
    this.dataSizeForm.markAsTouched();

    if (isValid) {
      this.submitting &#x3D; true;

      const body &#x3D; Object.assign({},
        this.storageTypeForm.getRawValue(),
        this.projectForm.getRawValue(),
        this.dataInfoForm.getRawValue(),
        this.dataSizeForm.getRawValue());

      // Convert endDate into string
      body.endDate &#x3D; format(body.endDate, &#x27;YYYY-MM-DD&#x27;);

      this.cerApiService.requestService(&#x27;storage&#x27;, body)
        .subscribe(
          (response) &#x3D;&gt; {
            this.analyticsService.trackActionIntegrated(this.title);
            this.response &#x3D; response;
            this.stepper.selectedIndex &#x3D; this.lastStepIndex; // Navigate to last step
          },
          (err: HttpErrorResponse) &#x3D;&gt; {
            this.submitting &#x3D; false;

            if (err.status &#x3D;&#x3D;&#x3D; 401) {
              const dialogRef &#x3D; this.showErrorDialog(
                &#x27;Session expired&#x27;,
                &#x27;Redirecting to UoA Single Sign On...&#x27;,
                &#x27;Login&#x27;,
                5000
              );
              dialogRef.afterClosed().subscribe(result &#x3D;&gt; {
                const url &#x3D; this.location.path(false) + &#x27;?retry&#x3D;true&#x27;;
                this.saveRequest();
                this.authService.login(url);
              });
            } else {
              this.showErrorDialog(&#x60;${err.name}: ${err.status.toString()}&#x60;, JSON.stringify(err.error), &#x27;Close&#x27;, undefined);
            }
          });
    }
  }
}
</code></pre>
    </div>
</div>






                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'Person-1.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <script src="../js/menu-wc.js"></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
